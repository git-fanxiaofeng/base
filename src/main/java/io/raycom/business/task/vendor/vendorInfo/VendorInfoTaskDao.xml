<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.raycom.business.task.vendor.vendorInfo.VendorInfoTaskDao">
	
	<!-- 判断供应商是否已经存在 -->
	<select id="checkVendor" parameterType="rdata" resultType="rdata">
		SELECT	count(1)
		FROM	tb_uhq_vendor
		WHERE	ups_vendor_id=#{vendorId}
	</select>
	
	<!-- 供应商资质信息插入供应关系表中 -->
	<insert id="insertVhCert" parameterType="rdata">
		INSERT INTO tb_uhq_vh_cert
				(
				  vh_certificate_id,
				  vendor_hos_id,
				  ups_certificate_id,
	              vendor_id,
				  certificate_type,     
				  certificate_name,     
				  certificate_no,       
				  start_date,           
				  close_date,          
				  issue_dept,           
				  company_name,       
				  attach_id,                      
				  manufacture_name,
				  cert_parent_category,
				  authorized_name,	        
				  agency_order,                          
				  cert_iden,
				  vendor_name,
                  create_by,
                  create_date,
                  update_by,
                  update_date
	       		  )
	       VALUES(
	              SEQ_tb_uhq_vh_cert.nextval,
	              #{certificateId},
                  #{vendorId},       
                  #{certificateType},
                  #{certificateName},
                  #{certificateNo},  
                  to_date(#{startDate},'yyyy-mm-dd'),      
                  to_date(#{closeDate},'yyyy-mm-dd'),      
                  #{issueDept},      
                  #{companyName},  
                  #{attachId},       
                  #{manufactureName},
                  #{certParentCategory},
                  #{authorizedName},
                  #{agencyOrder},             
                  #{certIden},
                  (select vendor_ch_name from tb_uhq_vendor where vendor_id=#{vendorId}),         
                  'system',
                  sysdate,
                  'system',
                  sysdate
                  )
	</insert>
	
	<!-- 供应商资质信息插入资质历史表 -->
	<insert id="insertVendorCertHis" parameterType="rdata">
		INSERT INTO tb_uhq_vendor_cert_his
				(
	              his_certificate_id,
	              vendor_apply_id,
	              hos_id,
	              vendor_id, 
				  certificate_type,     
				  certificate_name,     
				  certificate_no,       
				  start_date,           
				  close_date,          
				  issue_dept,           
				  company_name,       
				  attach_id,                      
				  manufacture_name,
				  cert_parent_category,
				  authorized_name,	        
				  agency_order,                          
				  cert_iden,
				  vendor_name,
				  data_source,
                  create_by,
                  create_date,
                  update_by,
                  update_date
	       		  )
	       VALUES(
	              SEQ_tb_uhq_vendor_cert_his.nextval,
                  #{vendorApplyId},
                  #{hosId},
                  #{vendorId},       
                  #{certificateType},
                  #{certificateName},
                  #{certificateNo},  
                  to_date(#{startDate},'yyyy-mm-dd'),      
                  to_date(#{closeDate},'yyyy-mm-dd'),      
                  #{issueDept},      
                  #{companyName},  
                  #{attachId},       
                  #{manufactureName},
                  #{certParentCategory},
                  #{authorizedName},
                  #{agencyOrder},             
                  #{certIden},
                  (select vendor_ch_name from tb_uhq_vendor where vendor_id=#{vendorId}),         
                  'USC',
                  'system',
                  sysdate,
                  'system',
                  sysdate
                  )
	</insert>
	
	<!-- 供应商资质信息插入资质正式表 -->
	<insert id="insertVendorCert" parameterType="rdata">
		INSERT INTO tb_uhq_vendor_cert
				(
	              certificate_id,
	              ups_certificate_id,
	              vendor_id, 
				  certificate_type,     
				  certificate_name,     
				  certificate_no,       
				  start_date,           
				  close_date,          
				  issue_dept,           
				  company_name,       
				  attach_id,                      
				  manufacture_name,
				  cert_parent_category,
				  authorized_name,	        
				  agency_order,                          
				  cert_iden,
				  vendor_name,
                  create_by,
                  create_date,
                  update_by,
                  update_date
	       		  )
	       VALUES(
	              SEQ_tb_uhq_vendor_cert.nextval,
                  #{vendorId},       
                  #{certificateType},
                  #{certificateName},
                  #{certificateNo},  
                  to_date(#{startDate},'yyyy-mm-dd'),      
                  to_date(#{closeDate},'yyyy-mm-dd'),      
                  #{issueDept},      
                  #{companyName},  
                  #{attachId},       
                  #{manufactureName},
                  #{certParentCategory},
                  #{authorizedName},
                  #{agencyOrder},             
                  #{certIden},
                  (select vendor_ch_name from tb_uhq_vendor where vendor_id=#{vendorId}),         
                  'system',
                  sysdate,
                  'system',
                  sysdate
                  )
	</insert>
	
	<!-- 将usc同步的供应商信息插入供应商正式表 -->
	<insert id="insertVendor" parameterType="rdata">
		INSERT INTO tb_uhq_vendor
				 (                        	   
                      vendor_id,
                      ups_vendor_id,
                      hos_id,
					  vendor_ch_name,
					  nation,               
					  area,                
					  office_address,       
					  registered_address,   
					  registered_fund,      
					  corporation,          
					  introduction,         
					  company_type,         
					  tolerance_range,      
					  tax_id,                        
					  contact1,             
					  tel1,        
					  email1,               
					  contact2,             
					  tel2,        
					  email2,               
                      create_by,
                      create_date,
                      update_by,
                      update_date          
	       		  )
	       VALUES(
	 			     seq_tb_uhq_vendor.nextval,
	 			     #{vendorId},
	 			     #{orgId},                                 
                     #{vendorChName},                                  
                     #{nation},                          
                     #{area},                            
                     #{officeAddress},                   
                     #{registeredAddress},               
                     #{registeredFund},                  
                     #{corporation},                     
                     #{introduction},                    
                     #{companyType},                     
                     #{toleranceRange},                  
                     #{taxId},                                               
                     #{contact1},                        
                     #{tel1},                    
                     #{email1},                          
                     #{contact2},                        
                     #{tel2},                    
                     #{email2},                          
                     'system',
                     sysdate,
                     'system',
                     sysdate
                  ) 
	</insert>
	
	<!-- 插入供应商历史表 -->
	<insert id="insertVendorHis" parameterType="rdata">
		INSERT INTO tb_uhq_vendor_his
				 (                        	   
                      vendor_his_id,
                      vendor_id,
                      hos_id,
					  vendor_ch_name,
					  nation,               
					  area,                
					  office_address,       
					  registered_address,   
					  registered_fund,      
					  corporation,          
					  introduction,         
					  company_type,         
					  tolerance_range,      
					  tax_id,                        
					  contact1,             
					  tel1,        
					  email1,               
					  contact2,             
					  tel2,        
					  email2,               
                      create_by,
                      create_date,
                      update_by,
                      update_date,
                      data_source,
	       		  )
	       VALUES(
	 			     seq_tb_uhq_vendor_his.nextval,
	 			     #{vendorId},
	 			     #{orgId},                                 
                     #{vendorChName},                                  
                     #{nation},                          
                     #{area},                            
                     #{officeAddress},                   
                     #{registeredAddress},               
                     #{registeredFund},                  
                     #{corporation},                     
                     #{introduction},                    
                     #{companyType},                     
                     #{toleranceRange},                  
                     #{taxId},                                               
                     #{contact1},                        
                     #{tel1},                    
                     #{email1},                          
                     #{contact2},                        
                     #{tel2},                    
                     #{email2},                          
                     'system',
                     sysdate,
                     'system',
                     sysdate,
                     'usc'
                  ) 
	</insert>
	
	<!-- 插入供应商医院关联关系表 -->
	<insert id="insertVh" parameterType="rdata">
		INSERT INTO tb_uhq_vh
				 (                        	   
                      vendor_hos_id,
                      ups_vendor_id,
                      vendor_id,
                      hos_id,
					  vendor_ch_name,
					  nation,               
					  area,                
					  office_address,       
					  registered_address,   
					  registered_fund,      
					  corporation,          
					  introduction,         
					  company_type,         
					  tolerance_range,      
					  tax_id,                        
					  contact1,             
					  tel1,        
					  email1,               
					  contact2,             
					  tel2,        
					  email2,               
                      create_by,
                      create_date,
                      update_by,
                      update_date,
                      data_source,
	       		  )
	       VALUES(
	 			     seq_tb_uhq_vh.nextval,
	 			     #{vendorId},
	 			     (select vendorId from tb_uhq_vendor where ups_vendor_id=#{vendorId}),
	 			     #{orgId},                                 
                     #{vendorChName},                                  
                     #{nation},                          
                     #{area},                            
                     #{officeAddress},                   
                     #{registeredAddress},               
                     #{registeredFund},                  
                     #{corporation},                     
                     #{introduction},                    
                     #{companyType},                     
                     #{toleranceRange},                  
                     #{taxId},                                               
                     #{contact1},                        
                     #{tel1},                    
                     #{email1},                          
                     #{contact2},                        
                     #{tel2},                    
                     #{email2},                          
                     'system',
                     sysdate,
                     'system',
                     sysdate,
                     'usc'
                  ) 
	</insert>
	
	<!-- 将usc同步数据新增或更新到供应商信息审批表中 -->
	<update id="updateVhApply" parameterType="rdata">
		<selectKey keyProperty="myVendorApplyId" resultType="string" order="AFTER">  
	            SELECT vendor_apply_id  	"myVendorApplyId"
	              FROM tb_uhq_vh_apply v 
	             WHERE v.org_id=#{orgId}
		           AND del_flag = 'N'
		           AND v.external_apply_id=#{vendorId} 
	    </selectKey>
		MERGE INTO tb_uhq_vh_apply v
        USING      dual
        ON         (v.external_apply_id=#{vendorId} and v.org_id=#{orgId})
        WHEN MATCHED THEN
        UPDATE                       
	    SET   	      vendor_ch_name        =#{vendorChName},                     
					  nation                =#{nation},               
					  area                  =#{area},                
					  office_address        =#{officeAddress},       
					  registered_address    =#{registeredAddress},   
					  registered_fund       =#{registeredFund},      
					  corporation           =#{corporation},          
					  introduction          =#{introduction},         
					  company_type          =#{companyType},         
					  tolerance_range       =#{toleranceRange},      
					  tax_id                =#{taxId},                        
					  contact1              =#{contact1},             
					  tel1                  =#{tel1},        
					  email1                =#{email1},               
					  contact2              =#{contact2},             
					  tel2                  =#{tel2},        
					  email2                =#{email2},               
					  status                =#{status},               
					  base_status           =#{baseStatus},
					  update_by             ='system',        
				      update_date           =sysdate   
                where	    v.external_apply_id=#{vendorId} 
                and 		v.org_id=#{orgId}   	       		    
	         WHEN NOT MATCHED THEN                    	       		    
	       INSERT (                        	   
                      vendor_apply_id,
                      external_apply_id,                  
					  vendor_ch_name,       
					  org_id,               
					  nation,               
					  area,                
					  office_address,       
					  registered_address,   
					  registered_fund,      
					  corporation,          
					  introduction,         
					  company_type,         
					  tolerance_range,      
					  tax_id,                        
					  contact1,             
					  tel1,        
					  email1,               
					  contact2,             
					  tel2,        
					  email2,               
					  status,               
					  base_status,
                      create_by,
                      create_date,
                      update_by,
                      update_date          
	       		  )
	       VALUES(
	 			     seq_usc_vh_apply.nextval,
	 			     #{vendorId},                                 
                     #{vendorChName},                                  
	                 #{orgId},                           
                     #{nation},                          
                     #{area},                            
                     #{officeAddress},                   
                     #{registeredAddress},               
                     #{registeredFund},                  
                     #{corporation},                     
                     #{introduction},                    
                     #{companyType},                     
                     #{toleranceRange},                  
                     #{taxId},                                               
                     #{contact1},                        
                     #{tel1},                    
                     #{email1},                          
                     #{contact2},                        
                     #{tel2},                    
                     #{email2},                          
                     #{status},                          
                     #{baseStatus},
                     'system',
                     sysdate,
                     'system',
                     sysdate
                  ) 
          </update> 
          
    <!--更新资质信息审批表  -->
    <update id="updateCertApply" parameterType="rdata">
        MERGE INTO tb_uhq_vh_cert_apply v
        USING      dual
        ON         (v.external_certificate_id=#{applyCertificateId} and v.org_id=#{orgId})
        WHEN MATCHED THEN
        UPDATE                       
	    SET           certificate_type       =#{certificateType}, 
					  certificate_name       =#{certificateName},
					  certificate_no         =#{certificateNo}, 
					  start_date             =to_date(#{startDate},'yyyy-mm-dd'),
					  close_date             =to_date(#{closeDate},'yyyy-mm-dd'), 
					  issue_dept             =#{issueDept},
					  authorized_name        =#{authorizedName},
					  attach_id              =#{attachId},        
					  manufacture_name       =#{manufactureName}, 
					  company_name           =#{companyName},
					  cert_parent_category   =#{certParentCategory},
					  approve_status         =#{approveStatus},
					  cert_iden              =#{certIden},
					  update_by              ='system',        
				      update_date            =sysdate,
				      del_flag               ='N'         
                where	    v.external_certificate_id=#{applyCertificateId} 
                and 		v.org_id=#{orgId}   	       		    
	         WHEN NOT MATCHED THEN                    	       		    
	       INSERT (
	              apply_certificate_id,
	              vendor_apply_id,
	              external_certificate_id,                        	          
				  org_id,               
				  vendor_id,            
				  certificate_type,     
				  certificate_name,     
				  certificate_no,       
				  start_date,           
				  close_date,          
				  issue_dept,           
				  company_name,       
				  attach_id,                      
				  manufacture_name,
				  cert_parent_category,
				  authorized_name,	        
				  agency_order,                          
				  approve_status,
				  approve_option,
				  approver,
				  cert_iden,
                  create_by,
                  create_date,
                  update_by,
                  update_date
	       		  )
	       VALUES(
	              SEQ_UHQ_VH_CERT_APPLY.nextval,
                  #{myVendorApplyId},                                    
                  #{applyCertificateId},   
                  #{orgId},          
                  #{vendorId},       
                  #{certificateType},
                  #{certificateName},
                  #{certificateNo},  
                  to_date(#{startDate},'yyyy-mm-dd'),      
                  to_date(#{closeDate},'yyyy-mm-dd'),      
                  #{issueDept},      
                  #{companyName},  
                  #{attachId},       
                  #{manufactureName},
                  #{certParentCategory},
                  #{authorizedName},
                  #{agencyOrder},             
                  #{approveStatus},         
                  #{approveOption},         
                  #{approver},         
                  #{certIden},         
                  'system',
                  sysdate,
                  'system',
                  sysdate
                  )
    </update>
    
    <!--更新资质单元审批主表  -->
    <update id="updateCertUnitMstApply" parameterType="rdata">
        MERGE INTO tb_uhq_vh_cert_unit_apply_mst v
        USING      dual
        ON         (v.external_mst_id=#{applyMstId} and v.org_id=#{orgId})
        WHEN MATCHED THEN
        UPDATE                       
	    SET       company_name     =#{companyName},     
				  company_type     =#{companyType},   
				  status           =#{status},                
				  update_by        ='system',        
				  update_date      =sysdate,
				  del_flag         ='N'      
                where	    v.external_mst_id=#{applyMstId} 
                and 		v.org_id=#{orgId}   	       		    
	         WHEN NOT MATCHED THEN                    	       		    
	       INSERT (                        	   
                  apply_mst_id,
                  external_mst_id,
                  vendor_apply_id,
                  org_id,
                  company_name,
                  company_type,
                  status,
                  create_by,
                  create_date,
                  update_by,
                  update_date
	       		  )
	       VALUES(
	              seq_uhq_vh_cert_unit_apply_mst.nextval,
                  #{applyMstId},
                  #{myVendorApplyId},
                  #{orgId},
                  #{companyName},
                  #{companyType},
                  #{status},
                  'system',
                  sysdate,
                  'system',
                  sysdate
                  ) 
    </update>
    
    <!--更新资质单元审批子表  -->
    <update id="updateCertUnitDtlApply" parameterType="rdata">
        MERGE INTO tb_uhq_vh_cert_unit_apply_dtl v
        USING      dual
        ON         (v.external_dtl_id=#{applyDtlId} and v.org_id=#{orgId})
        WHEN MATCHED THEN
        UPDATE                       
	    SET       agency_order              =#{agencyOrder},                
				  update_by                 ='system',        
				  update_date               =sysdate,
				  del_flag                  ='N'      
                where	    v.external_dtl_id=#{applyDtlId} 
                and 		v.org_id=#{orgId}   	       		    
	         WHEN NOT MATCHED THEN                    	       		    
	       INSERT (                        	   
                  apply_mst_id,
                  apply_dtl_id,
                  apply_certificate_id,
                  external_dtl_id,
                  vendor_apply_id,
                  org_id,
                  agency_order,
                  create_by,
                  create_date,
                  update_by,
                  update_date
	       		  )
	       VALUES(
	              (select apply_mst_id from tb_uhq_vh_cert_unit_apply_mst where external_mst_id=#{applyMstId} and del_flag='N'),
	              seq_uhq_vh_cert_unit_apply_dtl.nextval,
	              (select apply_certificate_id from tb_uhq_vh_cert_apply where external_certificate_id=#{applyCertificateId} and del_flag='N'),
                  #{applyDtlId},
                  #{myVendorApplyId},
                  #{orgId},
                  #{agencyOrder},
                  'system',
                  sysdate,
                  'system',
                  sysdate
                  )     
    </update>
    
    <!-- 将资质信息全部标记为Y -->
    <update id="deleteCertApplyAll" parameterType="rdata">
         UPDATE   tb_uhq_vh_cert_apply
         SET      del_flag='Y',
         		  update_by='system',
         		  update_date=sysdate
         WHERE    vendor_apply_id=#{myVendorApplyId} 
         AND      org_id=#{orgId}
         AND      del_flag='N'
    </update>
    
    <!-- 将资质单元主表全部标记为Y -->
    <update id="deleteCertUnitMstApplyAll" parameterType="rdata">
         UPDATE   tb_usc_vh_cert_unit_apply_mst
         SET      del_flag='Y',
         		  update_by='system',
         		  update_date=sysdate
         WHERE    vendor_apply_id=#{myVendorApplyId} 
         AND      org_id=#{orgId}
         AND      del_flag='N'      
    </update>
    
    <!-- 将资质单元子表全部标记为Y -->
    <update id="deleteCertUnitDtlApplyAll" parameterType="rdata">
         UPDATE   tb_usc_vh_cert_unit_apply_dtl
         SET      del_flag='Y',
         		  update_by='system',
         		  update_date=sysdate
         WHERE    vendor_apply_id=#{myVendorApplyId} 
         AND      org_id=#{orgId}
         AND      del_flag='N'
    </update>
</mapper>                     